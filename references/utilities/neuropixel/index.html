
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../direct-download/">
      
      
        <link rel="next" href="../ccf-volumes/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.32">
    
    
      
        <title>Data Preprocessing - Allen Project Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.3cba04c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#preprocessing-tools" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Allen Project Documentation" class="md-header__button md-logo" aria-label="Allen Project Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Allen Project Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Data Preprocessing
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Allen Project Documentation" class="md-nav__button md-logo" aria-label="Allen Project Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Allen Project Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../DVC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DVC Framework
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../notion/Allen%20project%20d3cfe5aab8384495b58fba8a47eeadcc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Experiment History
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    References
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Experiments
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Experiments
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/layer-rank/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Layer Ranks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/layer-interaction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Layer Interaction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/multiple-timeslices-layers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multiple Time Slices: Layers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/multiple-timeslices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multiple Time Slices
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/rrr-time-slice/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reduced Rank Regression Time Slice
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/crosstime/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Crosstime
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/time-lag-search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Time lag search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/cv-time-lag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cross-Validation-fold, Time-lag, and Rank search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/rrr-score-time/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reduced Rank Regression (RRR) Score-Time Plot
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/cv-rank-time/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cross-Validation-fold Exploration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/lag-along-time/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lag along Time
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/rank-along-time/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rank Along Time
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/control-models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Control Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/rrr-rank/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reduced Rank Regression Rank Optimization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/time-lag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Time-lag search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/histograms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Histograms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/pca/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Principal Component Analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/rrr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reduced Rank Regression along Time
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../experiments/cca/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Canonical Correlation Analysis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" checked>
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tools
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data-io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data I/O
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../direct-download/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Direct Download
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Data Preprocessing
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Data Preprocessing
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#utils.download_allen" class="md-nav__link">
    <span class="md-ellipsis">
      download_allen
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.download_allen.cacheData" class="md-nav__link">
    <span class="md-ellipsis">
      cacheData
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.download_allen.completeDownloadData" class="md-nav__link">
    <span class="md-ellipsis">
      completeDownloadData
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel" class="md-nav__link">
    <span class="md-ellipsis">
      neuropixel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables" class="md-nav__link">
    <span class="md-ellipsis">
      AllenTables
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AllenTables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.layer_assignment" class="md-nav__link">
    <span class="md-ellipsis">
      layer_assignment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.make_columns" class="md-nav__link">
    <span class="md-ellipsis">
      make_columns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.make_tables" class="md-nav__link">
    <span class="md-ellipsis">
      make_tables
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.dict_from_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      dict_from_dataframe
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_area_change_responses" class="md-nav__link">
    <span class="md-ellipsis">
      get_area_change_responses
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_area_receptive_fields" class="md-nav__link">
    <span class="md-ellipsis">
      get_area_receptive_fields
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_area_units" class="md-nav__link">
    <span class="md-ellipsis">
      get_area_units
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_average_unit_responses" class="md-nav__link">
    <span class="md-ellipsis">
      get_average_unit_responses
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_response_magnitudes" class="md-nav__link">
    <span class="md-ellipsis">
      get_response_magnitudes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_stimulus_presentations" class="md-nav__link">
    <span class="md-ellipsis">
      get_stimulus_presentations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_table" class="md-nav__link">
    <span class="md-ellipsis">
      get_table
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_unit_channels" class="md-nav__link">
    <span class="md-ellipsis">
      get_unit_channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_unit_responses" class="md-nav__link">
    <span class="md-ellipsis">
      get_unit_responses
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.makePSTH" class="md-nav__link">
    <span class="md-ellipsis">
      makePSTH
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.optotagging" class="md-nav__link">
    <span class="md-ellipsis">
      optotagging
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.rasterplot" class="md-nav__link">
    <span class="md-ellipsis">
      rasterplot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.stimulus_duration" class="md-nav__link">
    <span class="md-ellipsis">
      stimulus_duration
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ccf-volumes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CCF Volumes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Important Utility Tools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Plots
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../megaplot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Megaplot
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../other-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Other Utility Tools
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#utils.download_allen" class="md-nav__link">
    <span class="md-ellipsis">
      download_allen
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.download_allen.cacheData" class="md-nav__link">
    <span class="md-ellipsis">
      cacheData
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.download_allen.completeDownloadData" class="md-nav__link">
    <span class="md-ellipsis">
      completeDownloadData
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel" class="md-nav__link">
    <span class="md-ellipsis">
      neuropixel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables" class="md-nav__link">
    <span class="md-ellipsis">
      AllenTables
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AllenTables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.layer_assignment" class="md-nav__link">
    <span class="md-ellipsis">
      layer_assignment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.make_columns" class="md-nav__link">
    <span class="md-ellipsis">
      make_columns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utils.neuropixel.AllenTables.make_tables" class="md-nav__link">
    <span class="md-ellipsis">
      make_tables
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.dict_from_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      dict_from_dataframe
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_area_change_responses" class="md-nav__link">
    <span class="md-ellipsis">
      get_area_change_responses
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_area_receptive_fields" class="md-nav__link">
    <span class="md-ellipsis">
      get_area_receptive_fields
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_area_units" class="md-nav__link">
    <span class="md-ellipsis">
      get_area_units
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_average_unit_responses" class="md-nav__link">
    <span class="md-ellipsis">
      get_average_unit_responses
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_response_magnitudes" class="md-nav__link">
    <span class="md-ellipsis">
      get_response_magnitudes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_stimulus_presentations" class="md-nav__link">
    <span class="md-ellipsis">
      get_stimulus_presentations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_table" class="md-nav__link">
    <span class="md-ellipsis">
      get_table
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_unit_channels" class="md-nav__link">
    <span class="md-ellipsis">
      get_unit_channels
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.get_unit_responses" class="md-nav__link">
    <span class="md-ellipsis">
      get_unit_responses
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.makePSTH" class="md-nav__link">
    <span class="md-ellipsis">
      makePSTH
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.optotagging" class="md-nav__link">
    <span class="md-ellipsis">
      optotagging
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.rasterplot" class="md-nav__link">
    <span class="md-ellipsis">
      rasterplot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils.neuropixel.stimulus_duration" class="md-nav__link">
    <span class="md-ellipsis">
      stimulus_duration
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="preprocessing-tools">Preprocessing Tools</h1>


<div class="doc doc-object doc-module">



<a id="utils.download_allen"></a>
    <div class="doc doc-contents first">

      <p>This module contains functions for downloading and initializing data from the Allen Brain Observatory.</p>
<p>Functions:
- cacheData(location="") -&gt; EcephysProjectCache: Caches data from the Allen Brain Observatory.
- completeDownloadData(sessions, cache, output_dir, download_lfp=False) -&gt; None: Downloads the complete dataset for analysis.</p>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="utils.download_allen.cacheData" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cacheData</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Caches data from the Allen Brain Observatory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>location</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The location where the data will be cached. If not provided, the default location will be used.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>cache</code></td>            <td>
                  <code><span title="allensdk.brain_observatory.ecephys.ecephys_project_cache.EcephysProjectCache">EcephysProjectCache</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cache object containing the cached data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/download_allen.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">cacheData</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caches data from the Allen Brain Observatory.</span>

<span class="sd">    Args:</span>
<span class="sd">        location (str): The location where the data will be cached. If not provided, the default location will be used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        cache (EcephysProjectCache): The cache object containing the cached data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set the cache location</span>
    <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cache location:&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">])</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

    <span class="c1"># Confirm the allensdk version</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Your allensdk version is: </span><span class="si">{</span><span class="n">allensdk</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create the cache object</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">EcephysProjectCache</span><span class="p">(</span><span class="n">manifest</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;manifest.json&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">cache</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.download_allen.completeDownloadData" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">completeDownloadData</span><span class="p">(</span><span class="n">sessions</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">download_lfp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Downloads the complete dataset for analysis.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>sessions</code></td>
            <td>
                  <code>DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing session information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>cache</code></td>
            <td>
                  <code>Cache</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An object representing the cache.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_dir</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The directory where the downloaded data will be stored.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>download_lfp</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to download LFP data files. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>This function downloads the complete dataset by iterating over each session in the provided DataFrame.</li>
<li>It checks for the presence of the complete file to ensure that the download is not interrupted due to an unreliable connection.</li>
<li>Make sure that you have enough space available in your cache directory before running this code.
  You'll need around 855 GB for the whole dataset, and 147 GB if you're not downloading the LFP data files.</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>utils/download_allen.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">completeDownloadData</span><span class="p">(</span><span class="n">sessions</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">download_lfp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Downloads the complete dataset for analysis.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        sessions (DataFrame): A DataFrame containing session information.</span>
<span class="sd">        cache (Cache): An object representing the cache.</span>
<span class="sd">        output_dir (str): The directory where the downloaded data will be stored.</span>
<span class="sd">        download_lfp (bool, optional): Whether to download LFP data files. Defaults to False.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - This function downloads the complete dataset by iterating over each session in the provided DataFrame.</span>
<span class="sd">        - It checks for the presence of the complete file to ensure that the download is not interrupted due to an unreliable connection.</span>
<span class="sd">        - Make sure that you have enough space available in your cache directory before running this code.</span>
<span class="sd">          You&#39;ll need around 855 GB for the whole dataset, and 147 GB if you&#39;re not downloading the LFP data files.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sessions</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

        <span class="n">truncated_file</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;/session_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">session_id</span><span class="p">))</span>

        <span class="k">while</span> <span class="n">truncated_file</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_session_data</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">specimen_name</span><span class="p">)</span>
                <span class="n">truncated_file</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Truncated spikes file, re-downloading&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloaded session &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">session_id</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">download_lfp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">probe_id</span><span class="p">,</span> <span class="n">probe</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">probes</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">probe</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                <span class="n">truncated_lfp</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">while</span> <span class="n">truncated_lfp</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lfp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_lfp</span><span class="p">(</span><span class="n">probe_id</span><span class="p">)</span>
                        <span class="n">truncated_lfp</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s1">&#39;/probe_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">probe_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_lfp.nwb&#39;</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Truncated LFP file, re-downloading&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  LFP file not found.&quot;</span><span class="p">)</span>
                        <span class="n">truncated_lfp</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="utils.neuropixel"></a>
    <div class="doc doc-contents first">

      <p>This submodule contains tools for working with Neuropixel data from the Allen Institute.</p>
<p><strong>Functions</strong>:</p>
<ul>
<li>get_table(cache, session_id, table_name) -&gt; DataFrame: Get a table from the cache.</li>
<li>dict_from_dataframe(df, name) -&gt; dict: Create a dictionary from a DataFrame.</li>
<li>AllenTables(cache, session_id, layer_assignment=False) -&gt; AllenTables: Create an AllenTables object.</li>
<li>get_unit_channels(session, log_all_areas=False) -&gt; DataFrame: Get the unit channels for the given session.</li>
<li>makePSTH(spikes, startTimes, windowDur, binSize=0.001) -&gt; tuple: Compute the Peri-Stimulus Time Histogram (PSTH).</li>
<li>get_stimulus_presentations(session) -&gt; DataFrame: Get the stimulus presentations for the given session.</li>
<li>get_area_units(units: pd.DataFrame, area_of_interest) -&gt; DataFrame: Get the units in a specific area of interest.</li>
<li>get_area_change_responses(session, area_of_interest) -&gt; np.ndarray: Get the change responses for the units in the area of interest.</li>
<li>get_area_receptive_fields(spike_times, stimulus_presentations, area_of_interest) -&gt; list: Get the receptive fields for the units in the area of interest.</li>
<li>optotagging(opto_table, spike_times, area_of_interest) -&gt; np.ndarray: Perform optotagging analysis on the units in the area of interest.</li>
<li>get_response_magnitudes(opto_response) -&gt; np.ndarray: Calculate the response magnitudes of optogenetic stimulation.</li>
<li>get_average_unit_responses(units, spike_times, trial_start, duration=0.03, binSize=0.001) -&gt; np.ndarray: Calculate the unit responses for each unit in the given units DataFrame.</li>
<li>get_unit_responses(units, spike_times, trial_start, trial_end, stepSize=0.010, binSize=0.050, progressbar=True) -&gt; np.ndarray: Calculate the unit responses for each trial and time bin.</li>
</ul>
<p><strong>Classes</strong>:</p>
<ul>
<li>AllenTables: A class that represents tables related to Allen Institute's Neuropixel data.</li>
</ul>
<p><strong>Info</strong>:</p>
<p>This module provides functions and a class for working with Neuropixel data from the Allen Institute. It includes functions for retrieving specific tables from the cache, creating dictionaries from DataFrames, and performing various analyses on the data. The AllenTables class represents tables related to Neuropixel data and provides methods for creating tables and columns, assigning cortical layer information to units, and retrieving dataframes based on keys. The module also includes functions for computing the Peri-Stimulus Time Histogram (PSTH), getting unit channels, stimulus presentations, units in a specific area of interest, change responses for units in an area of interest, receptive fields for units in an area of interest, performing optotagging analysis, calculating response magnitudes of optogenetic stimulation, and calculating unit responses for each unit in a given DataFrame.</p>
<p><strong>Acronyms</strong>:</p>
<ul>
<li>VISp: Primary Visual Area (V1)</li>
<li>VISpl: Posterolateral visual area</li>
<li>VISli: Laterointermediate area (visually guided behav)</li>
<li>VISl: Lateral visual area (V2, LM)</li>
<li>VISal: Anteromedial visual area</li>
<li>VISlla: Laterolateral anterior visual area</li>
<li>VISrl: Rostrolateral visual area (visually guided behav)</li>
<li>VISam: Anteromedial visual area</li>
<li>VISpm: Posteromedial visual area (V4-V5, MT; PMC: associative area)</li>
<li>VISm: Medial visual area (V6, "medial motion area", see: https://pages.ucsd.edu/~msereno/papers/V6Motion09.pdf)</li>
<li>VISmma: Mediomedial anterior visual area</li>
<li>VISmmp: Mediomedial posterior visual area</li>
</ul>
<p>For more information, refer to the AllenSDK documentation: https://allensdk.readthedocs.io/en/latest/_static/examples/nb/ecephys_quickstart.html</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="utils.neuropixel.AllenTables" class="doc doc-heading">
            <code>AllenTables</code>


</h2>


    <div class="doc doc-contents ">


      <p>A class that represents tables related to Allen Institute's Neuropixel data.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="utils.neuropixel.AllenTables.cache">cache</span></code></td>
            <td>
                  <code>object</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cache object used to retrieve data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="utils.neuropixel.AllenTables.session_id">session_id</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the session.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="utils.neuropixel.AllenTables.make_tables" href="#utils.neuropixel.AllenTables.make_tables">make_tables</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Creates a dictionary of tables.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="utils.neuropixel.AllenTables.make_columns" href="#utils.neuropixel.AllenTables.make_columns">make_columns</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Creates a dictionary of columns.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="utils.neuropixel.AllenTables.layer_assignment" href="#utils.neuropixel.AllenTables.layer_assignment">layer_assignment</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Assigns cortical layer information to the units based on the channels and units tables.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="utils.neuropixel.AllenTables.__init__" href="#utils.neuropixel.AllenTables.__init__">__init__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Initializes the AllenTables object.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="utils.neuropixel.AllenTables.__getitem__" href="#utils.neuropixel.AllenTables.__getitem__">__getitem__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Retrieves a dataframe based on the given key.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>utils/neuropixel.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AllenTables</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that represents tables related to Allen Institute&#39;s Neuropixel data.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        cache (object): The cache object used to retrieve data.</span>
<span class="sd">        session_id (int): The ID of the session.</span>

<span class="sd">    Methods:</span>
<span class="sd">        make_tables: Creates a dictionary of tables.</span>
<span class="sd">        make_columns: Creates a dictionary of columns.</span>
<span class="sd">        layer_assignment: Assigns cortical layer information to the units based on the channels and units tables.</span>
<span class="sd">        __init__: Initializes the AllenTables object.</span>
<span class="sd">        __getitem__: Retrieves a dataframe based on the given key.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a dictionary of tables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tables (dict): A dictionary of tables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="c1"># &#39;behavior&#39;: self.behavior,</span>
            <span class="s1">&#39;probes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span>

    <span class="k">def</span> <span class="nf">make_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a dictionary of columns.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tables (dict): A dictionary of columns where the keys are the column names and the values are the assigned name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Get the columns from the dataframe</span>
            <span class="n">new_columns</span> <span class="o">=</span> <span class="n">dict_from_dataframe</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="c1"># Merge the new columns with the existing columns</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">new_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="c1"># Key exists in dictionary</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Key does not exist in dictionary, add it</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span>

    <span class="k">def</span> <span class="nf">layer_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assigns cortical layer information to the units based on the channels and units tables.</span>

<span class="sd">        This method uses the cortical_layer_assignment function to assign the cortical layer information</span>
<span class="sd">        to the units in the tables. The assigned layer information is then appended to the &#39;layer&#39; column</span>
<span class="sd">        in the columns list.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.units = cortical_layer_assignment(self.tables.channels, self.tables.units)</span>
        <span class="c1"># self.columns.append(&#39;layer&#39;)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">layer_assignment</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the AllenTables object.</span>

<span class="sd">        Args:</span>
<span class="sd">            cache (object): The cache object used to retrieve data.</span>
<span class="sd">            session_id (int): The ID of the session.</span>
<span class="sd">            layer_assignment (bool, optional): Whether to assign cortical layers to the units. Defaults to False.</span>

<span class="sd">        Note:</span>
<span class="sd">            The elapsed time for this function is approximately 0.198 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>

        <span class="n">session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_session_data</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get_session_table</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">session_id</span><span class="p">])</span>

        <span class="c1"># get the metadata tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get_session_table</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">session_id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;ecephys_session_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span>
        <span class="c1"># self.behavior = cache.get_behavior_session_table()[cache.get_behavior_session_table()[&#39;ecephys_session_id&#39;] == session_id]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">probes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">channels</span>

        <span class="c1"># Make the tables and columns utilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_tables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_columns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Assign cortical layers to the units</span>
        <span class="k">if</span> <span class="n">layer_assignment</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The layer_assignment method is not implemented yet.&quot;</span><span class="p">)</span> <span class="c1"># TODO: move this class to a new file, bcs the import of ccf files are too slow. Then just uncomment the lines in the layer_assignment function</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layer_assignment</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a dataframe based on the given key.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): The key to search for in the tables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: The dataframe containing the columns with the given key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make a mask for the self.tables with the key</span>
        <span class="n">key_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="c1"># If there are no tables with the key, return None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No tables with the key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Add the key to each list of the table if it is not already there</span>
        <span class="n">commonColNames</span> <span class="o">=</span> <span class="n">jointColumns</span>
        <span class="k">for</span> <span class="n">tab</span> <span class="ow">in</span> <span class="n">commonColNames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">commonColNames</span><span class="p">[</span><span class="n">tab</span><span class="p">]:</span>
                <span class="n">commonColNames</span><span class="p">[</span><span class="n">tab</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Get the columns with the key from each table</span>
        <span class="n">subtables</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">commonColNames</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">key_mask</span><span class="p">]</span>

        <span class="c1"># Merge the columns</span>
        <span class="n">mergedColumns</span> <span class="o">=</span> <span class="n">mergeDataframes</span><span class="p">(</span><span class="n">subtables</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mergedColumns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mergedColumns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: Do this whole procedure in __getitem__ twice (or more), to merge the distant columns. (In the first time it can be only a list with more than one merged subtables)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The mergedColumns is not a single dataframe&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="utils.neuropixel.AllenTables.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Retrieves a dataframe based on the given key.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>key</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The key to search for in the tables.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: The dataframe containing the columns with the given key.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a dataframe based on the given key.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (str): The key to search for in the tables.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: The dataframe containing the columns with the given key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make a mask for the self.tables with the key</span>
    <span class="n">key_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="c1"># If there are no tables with the key, return None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No tables with the key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Add the key to each list of the table if it is not already there</span>
    <span class="n">commonColNames</span> <span class="o">=</span> <span class="n">jointColumns</span>
    <span class="k">for</span> <span class="n">tab</span> <span class="ow">in</span> <span class="n">commonColNames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">commonColNames</span><span class="p">[</span><span class="n">tab</span><span class="p">]:</span>
            <span class="n">commonColNames</span><span class="p">[</span><span class="n">tab</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># Get the columns with the key from each table</span>
    <span class="n">subtables</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">commonColNames</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">key_mask</span><span class="p">]</span>

    <span class="c1"># Merge the columns</span>
    <span class="n">mergedColumns</span> <span class="o">=</span> <span class="n">mergeDataframes</span><span class="p">(</span><span class="n">subtables</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mergedColumns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mergedColumns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO: Do this whole procedure in __getitem__ twice (or more), to merge the distant columns. (In the first time it can be only a list with more than one merged subtables)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The mergedColumns is not a single dataframe&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="utils.neuropixel.AllenTables.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">layer_assignment</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Initializes the AllenTables object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>cache</code></td>
            <td>
                  <code>object</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cache object used to retrieve data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>session_id</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the session.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>layer_assignment</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to assign cortical layers to the units. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The elapsed time for this function is approximately 0.198 seconds.</p>
</details>
            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">layer_assignment</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the AllenTables object.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache (object): The cache object used to retrieve data.</span>
<span class="sd">        session_id (int): The ID of the session.</span>
<span class="sd">        layer_assignment (bool, optional): Whether to assign cortical layers to the units. Defaults to False.</span>

<span class="sd">    Note:</span>
<span class="sd">        The elapsed time for this function is approximately 0.198 seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_session_data</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get_session_table</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">session_id</span><span class="p">])</span>

    <span class="c1"># get the metadata tables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get_session_table</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">session_id</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;ecephys_session_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span>
    <span class="c1"># self.behavior = cache.get_behavior_session_table()[cache.get_behavior_session_table()[&#39;ecephys_session_id&#39;] == session_id]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">probes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">probes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">units</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">channels</span>

    <span class="c1"># Make the tables and columns utilities</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">make_tables</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">make_columns</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Assign cortical layers to the units</span>
    <span class="k">if</span> <span class="n">layer_assignment</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The layer_assignment method is not implemented yet.&quot;</span><span class="p">)</span> <span class="c1"># TODO: move this class to a new file, bcs the import of ccf files are too slow. Then just uncomment the lines in the layer_assignment function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_assignment</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="utils.neuropixel.AllenTables.layer_assignment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">layer_assignment</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Assigns cortical layer information to the units based on the channels and units tables.</p>
<p>This method uses the cortical_layer_assignment function to assign the cortical layer information
to the units in the tables. The assigned layer information is then appended to the 'layer' column
in the columns list.</p>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">layer_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assigns cortical layer information to the units based on the channels and units tables.</span>

<span class="sd">    This method uses the cortical_layer_assignment function to assign the cortical layer information</span>
<span class="sd">    to the units in the tables. The assigned layer information is then appended to the &#39;layer&#39; column</span>
<span class="sd">    in the columns list.</span>

<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="utils.neuropixel.AllenTables.make_columns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_columns</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Creates a dictionary of columns.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tables</code></td>            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of columns where the keys are the column names and the values are the assigned name.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a dictionary of columns.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tables (dict): A dictionary of columns where the keys are the column names and the values are the assigned name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Get the columns from the dataframe</span>
        <span class="n">new_columns</span> <span class="o">=</span> <span class="n">dict_from_dataframe</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Merge the new columns with the existing columns</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">new_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># Key exists in dictionary</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Key does not exist in dictionary, add it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="utils.neuropixel.AllenTables.make_tables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_tables</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Creates a dictionary of tables.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tables</code></td>            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of tables.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a dictionary of tables.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tables (dict): A dictionary of tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
        <span class="c1"># &#39;behavior&#39;: self.behavior,</span>
        <span class="s1">&#39;probes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">probes</span><span class="p">,</span>
        <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
        <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.dict_from_dataframe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dict_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Create a dictionary from a DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>df</code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DataFrame to convert.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>name</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name to assign to each column in the dictionary.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary where the keys are the column names and the values are the assigned name.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dict_from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a dictionary from a DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): The DataFrame to convert.</span>
<span class="sd">        name (str): The name to assign to each column in the dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where the keys are the column names and the values are the assigned name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">col_name</span><span class="p">:</span> <span class="n">name</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.get_area_change_responses" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_area_change_responses</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">area_of_interest</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Calculate the change responses for units in a specific area of interest.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>session</code></td>
            <td>
                  <code>Session</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>area_of_interest</code></td>
            <td>
                  <code>str or list[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The acronym of the area of interest.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray: An array containing the change responses.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_area_change_responses</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">area_of_interest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the change responses for units in a specific area of interest.</span>

<span class="sd">    Args:</span>
<span class="sd">        session (Session): The session object.</span>
<span class="sd">        area_of_interest (str or list[str]): The acronym of the area of interest.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: An array containing the change responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stimulus_presentations</span> <span class="o">=</span> <span class="n">get_stimulus_presentations</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="n">area_change_responses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">area_units</span> <span class="o">=</span> <span class="n">get_area_units</span><span class="p">(</span><span class="n">area_of_interest</span><span class="o">=</span><span class="n">area_of_interest</span><span class="p">)</span>
    <span class="n">spike_times</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">spike_times</span>
    <span class="n">time_before_change</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="k">for</span> <span class="n">iu</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">area_units</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">unit_spike_times</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">iu</span><span class="p">]</span>
        <span class="n">unit_change_response</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">makePSTH</span><span class="p">(</span><span class="n">unit_spike_times</span><span class="p">,</span>
                                                <span class="n">stimulus_presentations</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">time_before_change</span><span class="p">,</span>
                                                <span class="n">duration</span><span class="p">,</span> <span class="n">binSize</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">area_change_responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_change_response</span><span class="p">)</span>
    <span class="n">area_change_responses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">area_change_responses</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">area_change_responses</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.get_area_receptive_fields" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_area_receptive_fields</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">stimulus_presentations</span><span class="p">,</span> <span class="n">area_of_interest</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Get the receptive fields for units in a specific area of interest by Gabors. (There are many trials, and only in the second block are gabors for the receptive fields.)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>spike_times</code></td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping unit IDs to their corresponding spike times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>stimulus_presentations</code></td>
            <td>
                  <code>DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing the stimulus presentations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>area_of_interest</code></td>
            <td>
                  <code>str or list[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The acronym of the area of interest.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
                  <code>list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list containing the receptive fields.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_area_receptive_fields</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">stimulus_presentations</span><span class="p">,</span> <span class="n">area_of_interest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the receptive fields for units in a specific area of interest by Gabors. (There are many trials, and only in the second block are gabors for the receptive fields.)</span>

<span class="sd">    Args:</span>
<span class="sd">        spike_times (dict): A dictionary mapping unit IDs to their corresponding spike times.</span>
<span class="sd">        stimulus_presentations (DataFrame): A DataFrame containing the stimulus presentations.</span>
<span class="sd">        area_of_interest (str or list[str]): The acronym of the area of interest.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list containing the receptive fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rf_stim_table</span> <span class="o">=</span> <span class="n">stimulus_presentations</span><span class="p">[</span><span class="n">stimulus_presentations</span><span class="p">[</span><span class="s1">&#39;stimulus_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;gabor&#39;</span><span class="p">)]</span>

    <span class="c1"># position categories/ypes of gabor along azimuth</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">position_x</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="c1"># positions of gabor along elevation</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">position_y</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">find_rf</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">unit_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ys</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">xs</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iy</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ys</span><span class="p">):</span>
                <span class="n">stim_times</span> <span class="o">=</span> <span class="n">rf_stim_table</span><span class="p">[(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">position_x</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span>
                                            <span class="o">&amp;</span> <span class="p">(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">position_y</span> <span class="o">==</span> <span class="n">y</span><span class="p">)][</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">unit_response</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">makePSTH</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span>
                                                <span class="n">stim_times</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                                                <span class="mf">0.2</span><span class="p">,</span> <span class="n">binSize</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
                <span class="n">unit_rf</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_response</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">unit_rf</span>

    <span class="n">area_rfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">area_units</span> <span class="o">=</span> <span class="n">get_area_units</span><span class="p">(</span><span class="n">area_of_interest</span><span class="o">=</span><span class="n">area_of_interest</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iu</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">area_units</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">unit_spike_times</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">iu</span><span class="p">]</span>
        <span class="n">unit_rf</span> <span class="o">=</span> <span class="n">find_rf</span><span class="p">(</span><span class="n">unit_spike_times</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
        <span class="n">area_rfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_rf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">area_rfs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.get_area_units" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_area_units</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">area_of_interest</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Retrieve the units in a specific area of interest.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>units</code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DataFrame containing the units.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>area_of_interest</code></td>
            <td>
                  <code>str or list[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The acronym of the area of interest.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: A DataFrame containing the units in the specified area.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_area_units</span><span class="p">(</span><span class="n">units</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">area_of_interest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the units in a specific area of interest.</span>

<span class="sd">    Args:</span>
<span class="sd">        units (pd.DataFrame): The DataFrame containing the units.</span>
<span class="sd">        area_of_interest (str or list[str]): The acronym of the area of interest.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: A DataFrame containing the units in the specified area.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Filter the units based on the area of interest</span>
    <span class="n">good_unit_filter</span> <span class="o">=</span> <span class="p">((</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;isi_violations&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;firing_rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">))</span>
    <span class="n">good_units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">good_unit_filter</span><span class="p">]</span>

    <span class="c1"># Get the units in the area of interest</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">area_of_interest</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">area_units</span> <span class="o">=</span> <span class="n">good_units</span><span class="p">[</span><span class="n">good_units</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">area_of_interest</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">area_of_interest</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">area_units</span> <span class="o">=</span> <span class="n">good_units</span><span class="p">[</span><span class="n">good_units</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">area_of_interest</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;area_of_interest must be a string or a list of strings&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">area_units</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.get_average_unit_responses" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_average_unit_responses</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">,</span> <span class="n">trial_start</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">binSize</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Calculate the average unit responses for each unit in the given units DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>units</code></td>
            <td>
                  <code>DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing information about the units.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>spike_times</code></td>
            <td>
                  <code>list</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of spike times for each unit.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>trial_start</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start time of the trial.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>duration</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total duration of trial for PSTH in seconds. Default is 0.03.</p>
              </div>
            </td>
            <td>
                  <code>0.03</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>binSize</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Bin size for PSTH in seconds. Default is 0.001.</p>
              </div>
            </td>
            <td>
                  <code>0.001</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>response</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array containing the average unit responses, shape (units, duration/binSize)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_average_unit_responses</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">,</span> <span class="n">trial_start</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">binSize</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the average unit responses for each unit in the given units DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        units (DataFrame): DataFrame containing information about the units.</span>
<span class="sd">        spike_times (list): List of spike times for each unit.</span>
<span class="sd">        trial_start (float): Start time of the trial.</span>
<span class="sd">        duration (float): Total duration of trial for PSTH in seconds. Default is 0.03.</span>
<span class="sd">        binSize (float): Bin size for PSTH in seconds. Default is 0.001.</span>

<span class="sd">    Returns:</span>
<span class="sd">        response (numpy.ndarray): Array containing the average unit responses, shape (units, duration/binSize)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unit_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iu</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">unit_spike_times</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">iu</span><span class="p">]</span>
        <span class="n">unit_response</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">makePSTH</span><span class="p">(</span><span class="n">unit_spike_times</span><span class="p">,</span>
                                        <span class="n">trial_start</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span>
                                        <span class="n">binSize</span><span class="o">=</span><span class="n">binSize</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_response</span><span class="p">)</span>
        <span class="n">unit_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iu</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.get_response_magnitudes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_response_magnitudes</span><span class="p">(</span><span class="n">opto_response</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Calculate the response magnitudes of optogenetic stimulation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>opto_response</code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array containing the optogenetic response data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>response_magnitudes</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of response magnitudes calculated for each trial.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_response_magnitudes</span><span class="p">(</span><span class="n">opto_response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the response magnitudes of optogenetic stimulation.</span>

<span class="sd">    Args:</span>
<span class="sd">        opto_response (numpy.ndarray): Array containing the optogenetic response data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        response_magnitudes (numpy.ndarray): Array of response magnitudes calculated for each trial.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">baseline_window</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>  <span class="c1"># baseline epoch</span>
    <span class="n">response_window</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>  <span class="c1"># laser epoch</span>

    <span class="n">response_magnitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">opto_response</span><span class="p">[:,</span> <span class="n">response_window</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> \
                        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">opto_response</span><span class="p">[:,</span> <span class="n">baseline_window</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response_magnitudes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.get_stimulus_presentations" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_stimulus_presentations</span><span class="p">(</span><span class="n">session</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Retrieve the stimulus presentations for a given session.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>session</code></td>
            <td>
                  <code>Session</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>stimulus_presentations</code></td>            <td>
                  <code>DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing the stimulus presentations.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_stimulus_presentations</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the stimulus presentations for a given session.</span>

<span class="sd">    Args:</span>
<span class="sd">        session (Session): The session object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        stimulus_presentations (DataFrame): A DataFrame containing the stimulus presentations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stimulus_presentations</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">stimulus_presentations</span>
    <span class="k">return</span> <span class="n">stimulus_presentations</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.get_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_table</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Get a table from the cache.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>cache</code></td>
            <td>
                  <code>EcephysProjectCache</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cache object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>session_id</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>table_name</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the table to retrieve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>session_table</code></td>            <td>
                  <code>DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The table data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_table</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a table from the cache.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache (EcephysProjectCache): The cache object.</span>
<span class="sd">        session_id (int): The session identifier.</span>
<span class="sd">        table_name (str): The name of the table to retrieve.</span>

<span class="sd">    Returns:</span>
<span class="sd">        session_table (DataFrame): The table data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_session_data</span><span class="p">(</span><span class="n">session_id</span><span class="p">)[</span><span class="n">table_name</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.get_unit_channels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_unit_channels</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">log_all_areas</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Retrieve the unit channels for a given session.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>session</code></td>
            <td>
                  <code>Session</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>log_all_areas</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to log all brain areas recorded during the session. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: A DataFrame containing the unit channels.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_unit_channels</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">log_all_areas</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the unit channels for a given session.</span>

<span class="sd">    Args:</span>
<span class="sd">        session (Session): The session object.</span>
<span class="sd">        log_all_areas (bool, optional): Whether to log all brain areas recorded during the session. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: A DataFrame containing the unit channels.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Merging unit and channel dataframes will give us CCF coordinates for each unit</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_units</span><span class="p">()</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_channels</span><span class="p">()</span>
    <span class="n">unit_channels</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;peak_channel_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Which brain structures were recorded during this session</span>
    <span class="n">brain_areas_recorded</span> <span class="o">=</span> <span class="n">unit_channels</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log_all_areas</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">brain_areas_recorded</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">brain_areas_recorded</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">unit_channels</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.get_unit_responses" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_unit_responses</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">,</span> <span class="n">trial_start</span><span class="p">,</span> <span class="n">trial_end</span><span class="p">,</span> <span class="n">stepSize</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">binSize</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Calculate the unit responses for each trial and time bin.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>units</code></td>
            <td>
                  <code>DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing unit data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>spike_times</code></td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping unit IDs to their corresponding spike times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>trial_start</code></td>
            <td>
                  <code>array - like</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array-like object containing the start times of each trial.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>trial_end</code></td>
            <td>
                  <code>array - like</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array-like object containing the end times of each trial.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>stepSize</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of the time step. Defaults to 0.010.</p>
              </div>
            </td>
            <td>
                  <code>0.01</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>binSize</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of the time bin. Defaults to 0.050.</p>
              </div>
            </td>
            <td>
                  <code>0.05</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>progressbar</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to display a progress bar. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tensor</code></td>            <td>
                  <code>ndarray</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 3-dimensional numpy array containing the unit responses for each trial and time bin.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_unit_responses</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">,</span> <span class="n">trial_start</span><span class="p">,</span> <span class="n">trial_end</span><span class="p">,</span> <span class="n">stepSize</span><span class="o">=</span><span class="mf">0.010</span><span class="p">,</span> <span class="n">binSize</span><span class="o">=</span><span class="mf">0.050</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the unit responses for each trial and time bin.</span>

<span class="sd">    Args:</span>
<span class="sd">        units (DataFrame): A DataFrame containing unit data.</span>
<span class="sd">        spike_times (dict): A dictionary mapping unit IDs to their corresponding spike times.</span>
<span class="sd">        trial_start (array-like): An array-like object containing the start times of each trial.</span>
<span class="sd">        trial_end (array-like): An array-like object containing the end times of each trial.</span>
<span class="sd">        stepSize (float, optional): The size of the time step. Defaults to 0.010.</span>
<span class="sd">        binSize (float, optional): The size of the time bin. Defaults to 0.050.</span>
<span class="sd">        progressbar (bool, optional): Whether to display a progress bar. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tensor (ndarray): A 3-dimensional numpy array containing the unit responses for each trial and time bin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_unit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="n">n_trial</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trial_start</span><span class="p">)</span>
    <span class="n">trial_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trial_end</span> <span class="o">-</span> <span class="n">trial_start</span><span class="p">)</span>
    <span class="n">n_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trial_length</span> <span class="o">/</span> <span class="n">stepSize</span><span class="p">)</span>
    <span class="n">n_bin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trial_length</span> <span class="o">/</span> <span class="n">binSize</span><span class="p">)</span>

    <span class="n">tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_unit</span><span class="p">,</span> <span class="n">n_trial</span><span class="p">,</span> <span class="n">n_step</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">progressbar</span><span class="p">:</span>
        <span class="n">printProgressBar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_unit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;Units:&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit_ID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">unit_ID</span> <span class="k">for</span> <span class="n">unit_ID</span><span class="p">,</span> <span class="n">unit_data</span><span class="p">,</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]):</span>
        <span class="c1"># Get the spike times for the unit</span>
        <span class="n">unit_spike_times</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">unit_ID</span><span class="p">]</span>

        <span class="c1"># Loop through trials and time</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">trial_start</span><span class="p">,</span> <span class="n">trial_end</span><span class="p">)):</span>  <span class="c1"># Trials</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">stepSize</span><span class="p">)):</span> <span class="c1"># Time</span>

                <span class="c1"># Check if k is out of range. (This can happen because of different floating point rounding in int() and np.arange() functions i guess.)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">n_bin</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Find the bin indices</span>
                <span class="n">bin_start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">unit_spike_times</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
                <span class="n">bin_end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">unit_spike_times</span><span class="p">,</span> <span class="n">time</span><span class="o">+</span><span class="n">binSize</span><span class="p">)</span>

                <span class="c1"># Get the spikes in the time bin</span>
                <span class="n">spikes_in_timebin</span> <span class="o">=</span> <span class="n">unit_spike_times</span><span class="p">[</span><span class="n">bin_start_idx</span><span class="p">:</span><span class="n">bin_end_idx</span><span class="p">]</span>

                <span class="c1"># Count the number of spikes in the time bin</span>
                <span class="n">tensor</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes_in_timebin</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">progressbar</span><span class="p">:</span>
            <span class="n">printProgressBar</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_unit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;Units:&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="c1"># Count the number of spikes in the tensor</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Spike count in the data:&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tensor</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.makePSTH" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">makePSTH</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">startTimes</span><span class="p">,</span> <span class="n">windowDur</span><span class="p">,</span> <span class="n">binSize</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Compute the Peri-Stimulus Time Histogram (PSTH).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>spikes</code></td>
            <td>
                  <code>array - like</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of spike times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>startTimes</code></td>
            <td>
                  <code>array - like</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of stimulus start times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>windowDur</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Duration of the time window to consider for the PSTH.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>binSize</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of the time bins for the histogram. Defaults to 0.001.</p>
              </div>
            </td>
            <td>
                  <code>0.001</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>return</code></td>            <td>
                  <code>tuple[NDArray[float64], NDArray[floating[Any]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing the PSTH counts and the bin edges.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>The PSTH is a histogram that represents the firing rate of neurons in response to a stimulus over time.
It is computed by dividing the time window into bins and counting the number of spikes that fall into each bin.</p>
</details>
            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">makePSTH</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">startTimes</span><span class="p">,</span> <span class="n">windowDur</span><span class="p">,</span> <span class="n">binSize</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Compute the Peri-Stimulus Time Histogram (PSTH).</span>

<span class="sd">    Args:</span>
<span class="sd">        spikes (array-like): Array of spike times.</span>
<span class="sd">        startTimes (array-like): Array of stimulus start times.</span>
<span class="sd">        windowDur (float): Duration of the time window to consider for the PSTH.</span>
<span class="sd">        binSize (float, optional): Size of the time bins for the histogram. Defaults to 0.001.</span>

<span class="sd">    Returns:</span>
<span class="sd">        return (tuple[NDArray[float64], NDArray[floating[Any]]]): A tuple containing the PSTH counts and the bin edges.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The PSTH is a histogram that represents the firing rate of neurons in response to a stimulus over time.</span>
<span class="sd">        It is computed by dividing the time window into bins and counting the number of spikes that fall into each bin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">windowDur</span><span class="o">+</span><span class="n">binSize</span><span class="p">,</span> <span class="n">binSize</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bins</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># enumerate through trials</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">startTimes</span><span class="p">):</span>
        <span class="n">startInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="n">endInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">start</span><span class="o">+</span><span class="n">windowDur</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">spikes</span><span class="p">[</span><span class="n">startInd</span><span class="p">:</span><span class="n">endInd</span><span class="p">]</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">/</span><span class="n">startTimes</span><span class="o">.</span><span class="n">size</span>
    <span class="k">return</span> <span class="n">counts</span><span class="o">/</span><span class="n">binSize</span><span class="p">,</span> <span class="n">bins</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.optotagging" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optotagging</span><span class="p">(</span><span class="n">opto_table</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">,</span> <span class="n">area_of_interest</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Perform optotagging analysis on units in a specific area of interest.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>opto_table</code></td>
            <td>
                  <code>DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing the optotagging stimulus table.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>spike_times</code></td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping unit IDs to their corresponding spike times.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>area_of_interest</code></td>
            <td>
                  <code>str or list[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The acronym of the area of interest.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray: An array containing the optogenetic responses.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
      <p>Notes:</p>
<p>Since this is an SST mouse, we should see putative SST+ interneurons that are activated during our optotagging protocol. Let's load the optotagging stimulus table and plot PSTHs triggered on the laser onset. For more examples and useful info about optotagging, you can check out the Visual Coding Neuropixels Optagging notebook here (though note that not all the functionality in the visual coding SDK will work for this dataset).</p>
<p>We use 2 different laser <strong>waveforms</strong>: a short square pulse that's <strong>10 ms</strong> long and a half-period cosine that's 1 second long.
We drive each at three light <strong>levels</strong>, giving us 6 total conditions</p>
<p>most units don't respond to the short laser pulse.
Note that the activity occurring at the onset and offset of the laser is artifactual and should be excluded from analysis!</p>
<pre><code>opto_table = session.optotagging_table
</code></pre>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">optotagging</span><span class="p">(</span><span class="n">opto_table</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">,</span> <span class="n">area_of_interest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform optotagging analysis on units in a specific area of interest.</span>

<span class="sd">    Args:</span>
<span class="sd">        opto_table (DataFrame): A DataFrame containing the optotagging stimulus table.</span>
<span class="sd">        spike_times (dict): A dictionary mapping unit IDs to their corresponding spike times.</span>
<span class="sd">        area_of_interest (str or list[str]): The acronym of the area of interest.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: An array containing the optogenetic responses.</span>

<span class="sd">    Notes:</span>

<span class="sd">    Since this is an SST mouse, we should see putative SST+ interneurons that are activated during our optotagging protocol. Let&#39;s load the optotagging stimulus table and plot PSTHs triggered on the laser onset. For more examples and useful info about optotagging, you can check out the Visual Coding Neuropixels Optagging notebook here (though note that not all the functionality in the visual coding SDK will work for this dataset).</span>

<span class="sd">    We use 2 different laser **waveforms**: a short square pulse that&#39;s **10 ms** long and a half-period cosine that&#39;s 1 second long.</span>
<span class="sd">    We drive each at three light **levels**, giving us 6 total conditions</span>

<span class="sd">    most units don&#39;t respond to the short laser pulse.</span>
<span class="sd">    Note that the activity occurring at the onset and offset of the laser is artifactual and should be excluded from analysis!</span>

<span class="sd">    ```</span>
<span class="sd">    opto_table = session.optotagging_table</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">opto_table</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

    <span class="c1"># Get the short pulses</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">opto_table</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="c1"># Get the high power trials</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">opto_table</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;VIS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">area_of_interest</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;To perform optotagging, the area of interest must be a visual area&#39;</span><span class="p">)</span>

    <span class="n">cortical_units</span> <span class="o">=</span> <span class="n">get_area_units</span><span class="p">(</span><span class="n">area_of_interest</span><span class="o">=</span><span class="n">area_of_interest</span><span class="p">)</span>

    <span class="n">opto_times</span> <span class="o">=</span> <span class="n">opto_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">opto_table</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">duration</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">opto_table</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">level</span><span class="p">)][</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">time_before</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="mf">0.03</span>
    <span class="n">binSize</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">opto_response</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unit_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iu</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">cortical_units</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">unit_spike_times</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">iu</span><span class="p">]</span>
        <span class="n">unit_response</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">makePSTH</span><span class="p">(</span><span class="n">unit_spike_times</span><span class="p">,</span>
                                        <span class="n">opto_times</span> <span class="o">-</span> <span class="n">time_before</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span>
                                        <span class="n">binSize</span><span class="o">=</span><span class="n">binSize</span><span class="p">)</span>

        <span class="n">opto_response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_response</span><span class="p">)</span>
        <span class="n">unit_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iu</span><span class="p">)</span>

    <span class="n">opto_response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opto_response</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">opto_response</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.rasterplot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rasterplot</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Generate a raster plot for a given session and times.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>session</code></td>
            <td>
                  <code>Session</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>times</code></td>
            <td>
                  <code>DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The times DataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">rasterplot</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a raster plot for a given session and times.</span>

<span class="sd">    Args:</span>
<span class="sd">        session (Session): The session object.</span>
<span class="sd">        times (DataFrame): The times DataFrame.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">first_drifting_grating_presentation_id</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="s1">&#39;stimulus_presentation_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plot_times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">times</span><span class="p">[</span><span class="s1">&#39;stimulus_presentation_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">first_drifting_grating_presentation_id</span><span class="p">]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">raster_plot</span><span class="p">(</span><span class="n">plot_times</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;spike raster for stimulus presentation </span><span class="si">{</span><span class="n">first_drifting_grating_presentation_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Print out this presentation also</span>
    <span class="n">session</span><span class="o">.</span><span class="n">stimulus_presentations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">first_drifting_grating_presentation_id</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="utils.neuropixel.stimulus_duration" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stimulus_duration</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">stimulus_block</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Plot the histogram of stimulus durations for a given session and stimulus block.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>session</code></td>
            <td>
                  <code>Session</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>stimulus_block</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stimulus block.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>utils/neuropixel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">stimulus_duration</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">stimulus_block</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the histogram of stimulus durations for a given session and stimulus block.</span>

<span class="sd">    Args:</span>
<span class="sd">        session (Session): The session object.</span>
<span class="sd">        stimulus_block (int): The stimulus block.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stimulus_presentations</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">stimulus_presentations</span><span class="p">[</span><span class="n">session</span><span class="o">.</span><span class="n">stimulus_presentations</span><span class="p">[</span><span class="s1">&#39;active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="o">&amp;</span>
                                                            <span class="n">session</span><span class="o">.</span><span class="n">stimulus_presentations</span><span class="p">[</span><span class="s1">&#39;stimulus_block&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stimulus_block</span> <span class="o">&amp;</span>
                                                            <span class="n">session</span><span class="o">.</span><span class="n">stimulus_presentations</span><span class="p">[</span><span class="s1">&#39;omitted&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
    <span class="n">stimulus_presentations</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Flash Duration (s)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.471ce7a9.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>